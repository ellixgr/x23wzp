<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Minha Conta - Ganhar Moedas</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #ebebeb; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 380px; text-align: center; position: relative; }
        
        .moedas-box { background: #f0e6ff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #b78cff; }
        .moedas-count { font-size: 32px; font-weight: bold; color: #b78cff; }
        
        .btn-video { background: #25d366; color: white; border: none; padding: 15px 20px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; width: 100%; transition: 0.3s; text-transform: uppercase; box-shadow: 0 4px 0 #128c7e; margin-bottom: 10px; }
        .btn-video:active { box-shadow: none; transform: translateY(4px); }
        
        /* BOT√ÉO VIP */
        .btn-vip { background: #b78cff; color: white; border: none; padding: 15px 20px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; width: 100%; transition: 0.3s; text-transform: uppercase; box-shadow: 0 4px 0 #7a56c2; display: none; }
        .btn-vip:active { box-shadow: none; transform: translateY(4px); }

        .timer { margin-top: 10px; font-weight: bold; color: #e74c3c; display: none; }
        .aviso { font-size: 12px; color: #666; margin-top: 15px; line-height: 1.4; }
        #btn-voltar { margin-top: 20px; text-decoration: none; color: #b78cff; font-weight: bold; font-size: 14px; display: inline-block; }

        #custom-alert { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 999; align-items: center; justify-content: center; 
        }
        .modal-content { 
            background: white; padding: 20px; border-radius: 20px; width: 80%; max-width: 300px; 
            text-align: center; animation: scaleUp 0.3s ease;
        }
        @keyframes scaleUp { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        .modal-btn { background: #b78cff; color: white; border: none; padding: 10px 25px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* ID NO FUNDO DO SITE PORRA */
        .footer-spacer { flex-grow: 1; }
        .user-id-footer { margin-top: 50px; padding: 20px; font-size: 10px; color: #aaa; font-family: monospace; text-align: center; width: 100%; }
    </style>
</head>
<body>

<div id="custom-alert">
    <div class="modal-content">
        <h3 id="modal-title">Aviso</h3>
        <p id="modal-msg"></p>
        <button class="modal-btn" onclick="closeModal()">OK</button>
    </div>
</div>

<div class="container">
    <h2 style="margin-bottom: 10px;">Minhas Moedas</h2>
    <div class="moedas-box">
        <div id="saldo" class="moedas-count">0</div>
        <p style="font-size: 12px; color: #666;">Moedas acumuladas hoje</p>
    </div>
    
    <button id="btn-video" class="btn-video" onclick="iniciarVideo()">üé¨ VER V√çDEO (+1 MOEDA)</button>
    
    <button id="btn-resgatar" class="btn-vip" onclick="resgatarVip()">üíé RESGATAR VIP (30 MOEDAS)</button>
    
    <div id="timer-text" class="timer">Aguarde <span id="segundos">15</span>s para ganhar...</div>
    
    <div class="aviso">
        ‚ö†Ô∏è Limite di√°rio: <b>30 moedas</b>.<br>
        Junte 30 moedas e resgate seu c√≥digo VIP de 5 horas!
    </div>
</div>

<a href="index.html" id="btn-voltar">‚¨ÖÔ∏è Voltar aos Grupos</a>

<div class="footer-spacer"></div> <div class="user-id-footer">
    ID da Conta: <span id="display-id">carregando...</span>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, get, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDsrYjO2yVTemKqwmJRzNjh5sfaMalPqhE",
        databaseURL: "https://cliques-4a2c1-default-rtdb.firebaseio.com",
        projectId: "cliques-4a2c1",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let usuarioID = localStorage.getItem('usuarioID') || 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('usuarioID', usuarioID);
    document.getElementById('display-id').innerText = usuarioID;

    let moedasAtuais = 0;

    // Escutar moedas e mostrar bot√£o VIP
    onValue(ref(db, `usuarios/${usuarioID}/moedas`), (snap) => {
        moedasAtuais = snap.val() || 0;
        document.getElementById('saldo').innerText = moedasAtuais;
        
        const btnVip = document.getElementById('btn-resgatar');
        if (moedasAtuais >= 30) {
            btnVip.style.display = 'block';
        } else {
            btnVip.style.display = 'none';
        }
    });

    window.showAlert = function(titulo, msg) {
        document.getElementById('modal-title').innerText = titulo;
        document.getElementById('modal-msg').innerText = msg;
        document.getElementById('custom-alert').style.display = 'flex';
    };

    window.closeModal = function() {
        document.getElementById('custom-alert').style.display = 'none';
    };

    window.iniciarVideo = async function() {
        if(moedasAtuais >= 30) {
            return showAlert("‚ö†Ô∏è Limite", "Voc√™ j√° atingiu o limite de 30 moedas!");
        }
        const btn = document.getElementById('btn-video');
        const timerText = document.getElementById('timer-text');
        const segSpan = document.getElementById('segundos');

        btn.disabled = true;
        btn.innerText = "SORTEANDO V√çDEO...";

        try {
            const snapshot = await get(ref(db, 'videos_shopee'));
            let linkFinal = 'https://br.shp.ee/ehaxr08?smtt=0.0.9';

            if (snapshot.exists()) {
                const lista = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    const url = typeof data === 'string' ? data : data.link;
                    if (url) lista.push(url);
                });
                if (lista.length > 0) linkFinal = lista[Math.floor(Math.random() * lista.length)];
            }

            window.open(linkFinal, '_blank');

            timerText.style.display = 'block';
            let tempo = 15;
            const intv = setInterval(() => {
                tempo--;
                segSpan.innerText = tempo;
                if (tempo <= 0) {
                    clearInterval(intv);
                    timerText.style.display = 'none';
                    btn.innerText = "‚åõ VALIDANDO...";
                    validarNoServidor();
                }
            }, 1000);
        } catch (e) {
            btn.disabled = false;
        }
    };

    async function validarNoServidor() {
        const btn = document.getElementById('btn-video');
        try {
            const res = await fetch("https://x23wzp.onrender.com/ganhar-moeda", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuarioID: usuarioID })
            });
            const data = await res.json();
            if (data.success) showAlert("‚úÖ Sucesso", "Voc√™ ganhou +1 moeda!");
        } catch (e) {
            showAlert("üò¥ Servidor", "Erro. Tente de novo.");
        } finally {
            btn.disabled = false;
            btn.innerText = "üé¨ VER V√çDEO (+1 MOEDA)";
        }
    }

    // FUN√á√ÉO PARA GERAR O VIP DE 5 HORAS
    window.resgatarVip = async function() {
        if (moedasAtuais < 30) return;

        const btnVip = document.getElementById('btn-resgatar');
        btnVip.disabled = true;
        btnVip.innerText = "GERANDO C√ìDIGO...";

        try {
            const novoCodigo = "VIP-" + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // Salva o c√≥digo VIP no Firebase (Validade 5 horas)
            await set(ref(db, `codigos_vips/${novoCodigo}`), {
                status: "disponivel",
                validadeHoras: 5,
                criadoEm: new Date().toISOString()
            });

            // Zera as moedas do usu√°rio ap√≥s resgate
            await update(ref(db, `usuarios/${usuarioID}`), { moedas: 0 });

            showAlert("üíé VIP GERADO!", `Seu c√≥digo √©: ${novoCodigo}\n\nCopie e use agora para destacar seu grupo!`);
        } catch (e) {
            showAlert("‚ùå Erro", "Erro ao gerar VIP. Tente de novo.");
        } finally {
            btnVip.disabled = false;
            btnVip.innerText = "üíé RESGATAR VIP (30 MOEDAS)";
        }
    };
</script>
</body>
</html>
